<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gurmano Home Game</title>
<link rel="manifest" href="manifest.json" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F8FAF2">
<style>
  :root{
    --bg:#f8faf2;
    --card:#ffffff;
    --text:#222;
    --maria:#2e8b57;
    --luca:#c62828;
    --muted:#777;
    --accent:#F2C94C;
    --bar:#fafafa;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text)}
  .app {max-width:420px;margin:0 auto;padding:12px;padding-bottom:84px;} /* space for bottom bar */
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  h1{font-size:18px;margin:0}
  .scorebar{display:flex;gap:8px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:var(--card);box-shadow:0 1px 2px rgba(0,0,0,.05);display:flex;gap:8px;align-items:center}
  .dot{width:12px;height:12px;border-radius:50%}
  .dot.maria{background:var(--maria)} .dot.luca{background:var(--luca)}
  .controls{display:flex;gap:6px;margin:8px 0}
  .btn{padding:8px 10px;border-radius:8px;background:var(--card);border:1px solid #eee;font-weight:600}
  .calendar{background:var(--card);padding:8px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
  .weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:12px;color:var(--muted);padding:6px 0}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .day{
    min-height:70px;padding:6px;border-radius:8px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.02));
    font-size:12px;position:relative;overflow:hidden;
    -webkit-tap-highlight-color: transparent;
  }
  .day .number{position:absolute;top:6px;left:6px;font-weight:700}
  .entries{position:absolute;bottom:6px;left:6px;right:6px;display:flex;flex-wrap:wrap;gap:4px}
  .entry{font-size:12px;padding:3px 6px;border-radius:999px;background:rgba(0,0,0,.04);display:flex;align-items:center;gap:6px}
  .entry.maria{color:var(--maria);background:rgba(46,139,87,0.08)}
  .entry.luca{color:var(--luca);background:rgba(198,40,40,0.08)}
  .entry .smallx{font-weight:700;font-size:12px;padding:2px 6px;border-radius:6px;background:rgba(0,0,0,0.06)}
  .today{outline:2px solid rgba(0,0,0,.03)}
  footer{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:flex-end;justify-content:center;padding:12px;z-index:50}
  .sheet{width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
  label{display:block;margin-top:8px;font-size:13px}
  input[type="text"],select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eee;margin-top:6px}
  .row{display:flex;gap:6px}
  .legend-table{width:100%;border-collapse:collapse}
  .legend-table td{padding:6px;border-bottom:1px dashed #eee}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--accent);font-weight:700;color:#333}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .history-list{max-height:55vh;overflow:auto;padding:6px}
  .history-day{padding:8px;border-radius:8px;background:#fbfbfb;margin-bottom:8px}
  /* bottom bar */
  .bottom-bar{position:fixed;left:0;right:0;bottom:0;height:64px;background:var(--bar);display:flex;gap:8px;align-items:center;justify-content:space-around;padding:8px;border-top:1px solid #eee;z-index:60}
  .bb-btn{flex:1;height:48px;border-radius:10px;background:var(--card);border:1px solid #eee;font-weight:700;display:flex;align-items:center;justify-content:center}
  .hidden{display:none}
  @media(min-width:820px){.app{margin-top:20px}}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <h1>Giochi di Casa — Gurmano</h1>
    <div class="scorebar">
      <div class="pill"><div class="dot maria"></div><div id="score-maria">Maria: 0</div></div>
      <div class="pill"><div class="dot luca"></div><div id="score-luca">Luca: 0</div></div>
    </div>
  </header>

  <div id="main-view">
    <div class="controls">
      <button class="btn" id="prev-month">«</button>
      <div class="pill" id="month-label">—</div>
      <button class="btn" id="next-month">»</button>
      <button class="btn" id="open-legend" style="margin-left:auto">Legenda</button>
      <button class="btn" id="open-settings">Impostazioni</button>
    </div>

    <div class="calendar" id="calendar">
      <div class="weekdays">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>

    <footer>
      <div class="small">Regole: <em>Segnare i compiti completati; gli Ops li assegna l'altro giocatore. Tocca una voce per modificarla o eliminarla.</em></div>
      <div style="margin-left:auto" class="row">
        <button class="btn" id="summary-btn">Riepilogo mese</button>
      </div>
    </footer>
  </div>

  <div id="history-view" class="hidden">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <button class="btn" id="back-calendar">⬅️ Torna al calendario</button>
      <div style="font-weight:700;margin-left:8px" id="history-title">Storico</div>
    </div>
    <div class="history-list" id="history-list"></div>
  </div>

</div>

<div class="bottom-bar">
  <button class="bb-btn" id="export-bottom">Esporta</button>
  <button class="bb-btn" id="open-history-bottom">Storico</button>
  <button class="bb-btn" id="summary-bottom">Riepilogo mese</button>
</div>

<!-- modal container -->
<div id="modal-root"></div>

<script>
/* ========== Dati iniziali ========== */
const DEFAULT_STATE = {
  players: [
    {id:'maria', name:'Maria', color:'maria'},
    {id:'luca', name:'Luca', color:'luca'}
  ],
  records: {},
  tasks: {},
  recurring: [],
  settings: {
    currentYear: (new Date()).getFullYear(),
    currentMonth: (new Date()).getMonth()
  }
};

/* Preset tasks (italiano) */
const PRESET_TASKS = [ 
  {id:'t_feed_cat', title:'Dare da mangiare al gatto', points:1},
  {id:'t_6_mirror', title:'Lavare 6 specchi', points:1},
  {id:'t_wash_dishes', title:'Lavare i piatti', points:1},
  {id:'t_sink_after', title:'Pulire il lavello dopo i piatti', points:1},
  {id:'t_putaway_dishes', title:'Sistemare i piatti al loro posto', points:1},
  {id:'t_wipe_kitchen', title:'Pulire superfici orizzontali cucina',points:1},
  {id:'t_take_organic', title:'Portare fuori organico', points:1},
  {id:'t_prep_sort', title:'Preparare rifiuti per raccolta differenziata', points:1},
  {id:'t_vacuum_room', title:'Aspirare 1 stanza', points:1},
  {id:'t_cook_one', title:'Preparare 1 piatto', points:1},
  {id:'t_make_bed', title:'Rifare il letto', points:1},
  {id:'t_clean_sink_bath', title:'Lavare lavello in bagno', points:1},
  {id:'t_change_bulb', title:'Cambiare lampadina', points:2},
  {id:'t_dust_one_room', title:'Spolverare superfici orizzontali in 1 stanza', points:2},
  {id:'t_wash_clothes', title:'Lavare il bucato', points:2},
  {id:'t_hang_laundry', title:'Stendere il bucato', points:2},
  {id:'t_sort_laundry', title:'Raccogliere e separare il bucato', points:2},
  {id:'t_putaway_laundry', title:'Riporre vestiti nei loro posti', points:2},
  {id:'t_write_list', title:'Scrivere lista della spesa', points:2},
  {id:'t_put_away_food', title:'Sistemare i prodotti', points:2},
  {id:'t_clean_window', title:'Lavare 1 finestra', points:2},
  {id:'t_clean_toilets', title:'Pulire WC e bidet', points:2},
  {id:'t_clean_shower', title:'Pulire la doccia', points:2},
  {id:'t_shower_curtain', title:'Lavare la tenda della doccia', points:2},
  {id:'t_iron', title:'Stirare i vestiti', points:3},
  {id:'t_shop_35', title:'Fare la spesa ≥35€', points:3},
  {id:'t_tidy_10min', title:'Riordinare per 10 minuti', points:3},
  {id:'t_spiders', title:'Togliere ragnatele in casa', points:3},
  {id:'t_clean_shoe', title:'Pulire 1 paio di scarpe', points:3},
  {id:'t_defrost', title:'Sbrinare il frigorifero', points:3},
  {id:'t_vertical_wipe', title:'Pulire verticali in 1 stanza', points:3},
  {id:'t_unblock', title:'Versare pulitore nello scarico', points:3},
  {id:'t_mop_house', title:'Lavare i pavimenti in tutta la casa', points:4},
  {id:'t_high_dust', title:'Spolverare in alto su un mobile', points:4},
  {id:'t_wash_curtains', title:'Lavare le tende (togliere-lavare-asciugare-appendere)', points:4},
  {id:'t_clean_shower_drain', title:'Pulire lo scarico della doccia', points:4},
  {id:'t_lights', title:'Pulire i lampadari (corr, bagno, studio, camera)', points:5},
  {id:'t_clean_chair', title:'Lavare una sedia', points:5},
  {id:'t_wash_blanket', title:'Lavare il piumone in lavanderia', points:10}
];

const PRESET_OPS = [
  {id:'op_tp_roll', title:'Finire il rotolo di carta igienica e non sostituirlo', points:-5},
  {id:'op_leave_dirty', title:'Lasciare sporco dopo di sé', points:-1},
  {id:'op_no_new_bag', title:'Portare fuori immondizia e non mettere un sacco nuovo', points:-2}
];

function loadState(){
  try{
    const raw = localStorage.getItem('gamedata_v1');
    if(raw) return JSON.parse(raw);
  }catch(e){}
  const s = JSON.parse(JSON.stringify(DEFAULT_STATE));
  s.tasks = {};
  PRESET_TASKS.forEach(t => s.tasks[t.id] = {...t});
  PRESET_OPS.forEach(t => s.tasks[t.id] = {...t});
  s.recurring = [
    {taskId:'t_make_bed', weekday:6, description:'Ogni sabato: rifare federe'},
    {taskId:'t_mop_house', weekday:6, description:'Ogni sabato: lavare i pavimenti'}
  ];
  return s;
}
function saveState(s){ localStorage.setItem('gamedata_v1', JSON.stringify(s)); }
let STATE = loadState();

/* UI refs */
const grid = document.getElementById('grid');
const monthLabel = document.getElementById('month-label');
const scoreMariaEl = document.getElementById('score-maria');
const scoreLucaEl = document.getElementById('score-luca');

function formatMonth(year, month){
  const d = new Date(year, month, 1);
  return d.toLocaleString('it-IT', {month:'long', year:'numeric'});
}
function getMonthKey(y,m){ return y + '-' + String(m+1).padStart(2,'0'); }

function buildGrid(){
  const y = STATE.settings.currentYear;
  const m = STATE.settings.currentMonth;
  monthLabel.textContent = formatMonth(y,m);
  grid.innerHTML = '';
  const first = new Date(y,m,1);
  let offset = (first.getDay() + 6) % 7;
  const daysInMonth = new Date(y,m+1,0).getDate();
  let dayCounter = 1;
  for(let i=0;i<35;i++){
    const cell = document.createElement('div');
    cell.className = 'day';
    const isValid = (i >= offset) && (dayCounter <= daysInMonth);
    if(isValid){
      const dayNum = dayCounter;
      cell.innerHTML = '<div class="number">'+dayNum+'</div><div class="entries" data-day="'+dayNum+'"></div>';
      cell.dataset.day = dayNum;
      const today = new Date();
      if(today.getFullYear()===y && today.getMonth()===m && today.getDate()===dayNum) cell.classList.add('today');
      cell.addEventListener('click', ()=> openDayPopup(y,m,dayNum));
      dayCounter++;
    } else {
      cell.innerHTML = '';
      cell.style.background = 'transparent';
    }
    grid.appendChild(cell);
  }
  renderEntries();
  updateScores();
}

function renderEntries(){
  const y = STATE.settings.currentYear;
  const m = STATE.settings.currentMonth;
  const key = getMonthKey(y,m);
  const monthData = STATE.records[key] || {};
  document.querySelectorAll('.entries').forEach(e=> e.innerHTML='');
  for(const dayStr in monthData){
    const arr = monthData[dayStr];
    const day = Number(dayStr);
    const container = document.querySelector('.entries[data-day="'+day+'"]');
    if(!container) continue;
    // show only up to 3 small pills to avoid overflow
    arr.slice(0,3).forEach(rec => {
      const el = document.createElement('div');
      el.className = 'entry ' + (rec.playerId==='maria' ? 'maria' : 'luca');
      const sign = rec.delta>0 ? '+' : '';
      el.innerHTML = `<span class="text">${sign + rec.delta}</span>`;
      // small tap opens day popup and highlights
      el.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        openDayPopup(STATE.settings.currentYear, STATE.settings.currentMonth, day);
      });
      container.appendChild(el);
    });
    if(arr.length>3){
      const more = document.createElement('div'); more.className='entry'; more.textContent = '⋯';
      more.addEventListener('click',(ev)=>{ ev.stopPropagation(); openDayPopup(STATE.settings.currentYear, STATE.settings.currentMonth, day); });
      container.appendChild(more);
    }
  }
}

function updateScores(){
  const y = STATE.settings.currentYear;
  const m = STATE.settings.currentMonth;
  const key = getMonthKey(y,m);
  const monthData = STATE.records[key] || {};
  let sums = {maria:0, luca:0};
  for(const day in monthData){
    monthData[day].forEach(r=>{
      if(r.playerId==='maria') sums.maria += r.delta;
      else sums.luca += r.delta;
    });
  }
  scoreMariaEl.textContent = STATE.players[0].name + ': ' + sums.maria;
  scoreLucaEl.textContent = STATE.players[1].name + ': ' + sums.luca;
}

/* Day popup: shows entries for that day with delete buttons */
function openDayPopup(y,m,day){
  const modalRoot = document.getElementById('modal-root');
  modalRoot.innerHTML = '';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  sheet.innerHTML = `<div class="flex-between"><strong>Voci — ${day}/${m+1}/${y}</strong><button id="close">Chiudi</button></div>
    <div id="day-list" style="margin-top:8px"></div>
    <div style="margin-top:10px;display:flex;gap:8px"><button class="btn" id="add-new">Aggiungi voce</button><button class="btn" id="close2">Chiudi</button></div>`;
  modal.appendChild(sheet); modalRoot.appendChild(modal);
  sheet.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
  sheet.querySelector('#close2').addEventListener('click', ()=> modalRoot.innerHTML='');

  const listEl = sheet.querySelector('#day-list');
  const key = getMonthKey(y,m);
  const monthData = STATE.records[key] || {};
  const arr = (monthData[day] || []);
  if(arr.length===0) listEl.innerHTML = '<div class="small">Nessuna voce per questo giorno.</div>';
  arr.forEach(r=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px';
    const left = document.createElement('div'); left.textContent = (r.delta>0?'+':'')+r.delta + ' — ' + (r.note || (STATE.tasks[r.taskId] ? STATE.tasks[r.taskId].title : ''));
    const right = document.createElement('div');
    const del = document.createElement('button'); del.className='btn'; del.textContent='Elimina'; del.addEventListener('click', ()=>{
      if(!confirm('Eliminare questa voce?')) return;
      const idx = (monthData[day]||[]).findIndex(x=>x.id===r.id);
      if(idx>=0) monthData[day].splice(idx,1);
      saveState(STATE);
      modalRoot.innerHTML='';
      buildGrid();
    });
    right.appendChild(del);
    row.appendChild(left); row.appendChild(right);
    listEl.appendChild(row);
  });

  sheet.querySelector('#add-new').addEventListener('click', ()=> {
    openQuickAdd(y,m,day);
    // refresh after closing quick add will happen when modal is removed
  });
}

/* Quick add modal (same as before) */
function openQuickAdd(y,m,day){
  const modalRoot = document.getElementById('modal-root');
  modalRoot.innerHTML = '';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  sheet.innerHTML = `
    <div class="flex-between"><strong>Aggiungi voce — ${day}/${m+1}/${y}</strong>
      <button id="close">Chiudi</button></div>
    <label>Seleziona giocatore</label>
    <select id="player">
      <option value="maria">${STATE.players[0].name}</option>
      <option value="luca">${STATE.players[1].name}</option>
    </select>
    <label>Tipo</label>
    <select id="type">
      <option value="task">Compito</option>
      <option value="ops">Ops! (penalità)</option>
      <option value="custom">Custom</option>
    </select>
    <label id="task-label">Scegli compito</label>
    <select id="task-select"></select>
    <label id="note-label">Nota (opzionale)</label>
    <input id="note" type="text" placeholder="es. lavandino sporco">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="add-btn">Aggiungi</button>
      <button class="btn" id="cancel-btn">Annulla</button>
    </div>
  `;
  modal.appendChild(sheet);
  modalRoot.appendChild(modal);

  const player = sheet.querySelector('#player');
  const type = sheet.querySelector('#type');
  const taskSelect = sheet.querySelector('#task-select');
  const note = sheet.querySelector('#note');

  function fillTasks(filterType){
    taskSelect.innerHTML = '';
    const tasks = Object.values(STATE.tasks);
    tasks.forEach(t=>{
      if(filterType==='ops' && t.points < 0){
        const o = document.createElement('option'); o.value=t.id; o.textContent = `${t.title} (${t.points})`; taskSelect.appendChild(o);
      } else if(filterType==='task' && t.points>0){
        const o = document.createElement('option'); o.value=t.id; o.textContent = `${t.title} (+${t.points})`; taskSelect.appendChild(o);
      } else if(filterType==='custom'){
      }
    });
    if(taskSelect.children.length===0){
      const o = document.createElement('option'); o.value='__none'; o.textContent='— nessun elemento predefinito —'; taskSelect.appendChild(o);
    }
  }
  fillTasks('task');
  type.addEventListener('change', ()=>{
    if(type.value==='task'){ fillTasks('task'); taskLabel.textContent='Scegli compito'; noteLabel.textContent='Nota (opzionale)'; }
    else if(type.value==='ops'){ fillTasks('ops'); taskLabel.textContent='Scegli Ops!'; noteLabel.textContent='Motivo (opzionale)'; }
    else { taskSelect.innerHTML=''; const o=document.createElement('option'); o.value='custom'; o.textContent='Aggiungi custom...'; taskSelect.appendChild(o); taskLabel.textContent='Descrizione custom'; noteLabel.textContent='Punti (es. +2 o -1)'; }
  });

  sheet.querySelector('#close').addEventListener('click', closeModal);
  sheet.querySelector('#cancel-btn').addEventListener('click', closeModal);

  sheet.querySelector('#add-btn').addEventListener('click', ()=>{
    const playerId = player.value;
    let delta = 0;
    let taskId = null;
    let noteText = note.value.trim();
    if(type.value==='task'){
      taskId = taskSelect.value;
      const t = STATE.tasks[taskId];
      delta = t ? t.points : 0;
    } else if(type.value==='ops'){
      taskId = taskSelect.value;
      const t = STATE.tasks[taskId];
      delta = t ? t.points : 0;
    } else {
      const parsed = parseFloat(prompt('Inserisci punti (es. 1 o -2)'));
      delta = isNaN(parsed) ? 0 : parsed;
      taskId = 'custom-'+Math.random().toString(36).slice(2,8);
      STATE.tasks[taskId] = {id:taskId, title: note.value || 'Custom', points:delta};
    }
    const rec = { id: 'r_'+Math.random().toString(36).slice(2,9), playerId, delta, note:noteText, taskId, type:type.value, createdAt: Date.now() };
    addRecord(y,m,day, rec);
    closeModal();
  });

  function closeModal(){ modalRoot.innerHTML=''; buildGrid(); saveState(STATE); }
}

/* Edit / delete record modal (used from history) */
function openEditRecord(y,m,day,rec){
  const modalRoot = document.getElementById('modal-root'); modalRoot.innerHTML='';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  sheet.innerHTML = `
    <div class="flex-between"><strong>Modifica voce — ${day}/${m+1}/${y}</strong>
      <button id="close">Chiudi</button></div>
    <label>Giocatore</label>
    <select id="player">
      <option value="maria">${STATE.players[0].name}</option>
      <option value="luca">${STATE.players[1].name}</option>
    </select>
    <label>Punti (incl. segno)</label>
    <input id="delta" type="text" />
    <label>Nota</label>
    <input id="note" type="text" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="save-btn">Salva</button>
      <button class="btn" id="del-btn">Elimina</button>
      <button class="btn" id="cancel-btn">Annulla</button>
    </div>
  `;
  modal.appendChild(sheet); modalRoot.appendChild(modal);
  sheet.querySelector('#player').value = rec.playerId;
  sheet.querySelector('#delta').value = rec.delta;
  sheet.querySelector('#note').value = rec.note || '';
  sheet.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
  sheet.querySelector('#cancel-btn').addEventListener('click', ()=> modalRoot.innerHTML='');
  sheet.querySelector('#save-btn').addEventListener('click', ()=>{
    rec.playerId = sheet.querySelector('#player').value;
    rec.delta = Number(sheet.querySelector('#delta').value) || 0;
    rec.note = sheet.querySelector('#note').value;
    saveState(STATE);
    modalRoot.innerHTML=''; buildGrid();
  });
  sheet.querySelector('#del-btn').addEventListener('click', ()=>{
    if(!confirm('Eliminare questa voce?')) return;
    const key = getMonthKey(y,m);
    const monthData = STATE.records[key] || {};
    if(monthData[day]){
      const idx = monthData[day].findIndex(x=>x.id===rec.id);
      if(idx>=0) monthData[day].splice(idx,1);
      saveState(STATE);
      modalRoot.innerHTML=''; buildGrid();
    }
  });
}

/* Data ops */
function ensureMonthKey(y,m){
  const key = getMonthKey(y,m);
  if(!STATE.records[key]) STATE.records[key] = {};
  return key;
}
function addRecord(y,m,day,rec){
  const key = ensureMonthKey(y,m);
  if(!STATE.records[key][day]) STATE.records[key][day] = [];
  STATE.records[key][day].push(rec);
  saveState(STATE);
  renderEntries();
  updateScores();
}

/* Legend, settings, export/import, history */
document.getElementById('open-legend').addEventListener('click', openLegend);
document.getElementById('open-settings').addEventListener('click', openSettings);
document.getElementById('prev-month').addEventListener('click', ()=>{ if(STATE.settings.currentMonth===0){ STATE.settings.currentMonth=11; STATE.settings.currentYear--; } else STATE.settings.currentMonth--; buildGrid(); saveState(STATE); });
document.getElementById('next-month').addEventListener('click', ()=>{ if(STATE.settings.currentMonth===11){ STATE.settings.currentMonth=0; STATE.settings.currentYear++; } else STATE.settings.currentMonth++; buildGrid(); saveState(STATE); });

document.getElementById('export-bottom').addEventListener('click', ()=> {
  const y = STATE.settings.currentYear; const m = STATE.settings.currentMonth;
  const key = getMonthKey(y,m);
  const monthData = STATE.records[key] || {};
  // build csv lines
  let lines = [['date','player','points','note','taskId','createdAt']];
  for(const d of Object.keys(monthData).sort((a,b)=>a-b)){
    (monthData[d]||[]).forEach(r=>{
      lines.push([`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, r.playerId, r.delta, `"${(r.note||'').replace(/"/g,'""')}"`, r.taskId||'', r.createdAt||'']);
    });
  }
  const csv = lines.map(l=>l.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`storico-${getMonthKey(y,m)}.csv`; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('open-history-bottom').addEventListener('click', ()=> showHistoryView());
document.getElementById('summary-bottom').addEventListener('click', ()=> openSummary());
document.getElementById('summary-btn').addEventListener('click', ()=> openSummary());
document.getElementById('back-calendar').addEventListener('click', ()=> showCalendar());

function openLegend(){ 
  const modalRoot = document.getElementById('modal-root'); modalRoot.innerHTML='';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  sheet.innerHTML = `<div class="flex-between"><strong>Legenda compiti</strong><button id="close">Chiudi</button></div>
    <table class="legend-table"><tbody id="legend-body"></tbody></table>
    <div style="margin-top:8px"><strong>Ops! (penalità)</strong></div>
    <div id="ops-list"></div>
    <div style="margin-top:10px"><button class="btn" id="add-task">Aggiungi / Modifica compiti</button></div>`;
  modal.appendChild(sheet); modalRoot.appendChild(modal);
  sheet.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
  const tbody = sheet.querySelector('#legend-body');
  const tasks = Object.values(STATE.tasks).sort((a,b)=>a.points-b.points);
  const groups = {};
  tasks.forEach(t=>{ const key = String(t.points); if(!groups[key]) groups[key]=[]; groups[key].push(t); });
  tbody.innerHTML = '';
  [1,2,3,4,5,10].forEach(p=>{ const arr = groups[String(p)]; if(arr && arr.length){ const tr = document.createElement('tr'); tr.innerHTML = `<td><strong>${p} punto${p>1?'i':''}</strong></td><td>${arr.map(x=>x.title).join(' • ')}</td>`; tbody.appendChild(tr); } });
  const ops = tasks.filter(t=>t.points<0);
  const opsList = sheet.querySelector('#ops-list'); opsList.innerHTML = ops.map(o=>`<div>${o.title} (${o.points})</div>`).join('');
  sheet.querySelector('#add-task').addEventListener('click', ()=> openTaskEditor());
}

function openTaskEditor(){
  const modalRoot = document.getElementById('modal-root'); modalRoot.innerHTML='';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  let rows = Object.values(STATE.tasks).map(t=>{
    return `<div style="display:flex;gap:8px;margin-bottom:6px">
      <input type="text" data-id="${t.id}" value="${escapeHtml(t.title)}" style="flex:1"/>
      <input type="number" data-id-p="${t.id}" value="${t.points}" style="width:70px"/>
    </div>`;
  }).join('');
  sheet.innerHTML = `<div class="flex-between"><strong>Editor compiti</strong><button id="close">Chiudi</button></div>
    <div style="max-height:50vh;overflow:auto">${rows}</div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn" id="save-tasks">Salva</button>
      <button class="btn" id="add-new">Aggiungi nuovo</button>
    </div>`;
  modal.appendChild(sheet); modalRoot.appendChild(modal);
  sheet.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
  sheet.querySelector('#save-tasks').addEventListener('click', ()=>{
    sheet.querySelectorAll('input[type="text"]').forEach(inp=>{
      const id = inp.dataset.id;
      const title = inp.value.trim();
      const points = Number(sheet.querySelector(`input[data-id-p="${id}"]`).value) || 0;
      STATE.tasks[id] = {id, title, points};
    });
    saveState(STATE);
    alert('Salvato');
    modalRoot.innerHTML=''; buildGrid();
  });
  sheet.querySelector('#add-new').addEventListener('click', ()=>{
    const nid = 't'+Math.random().toString(36).slice(2,8);
    STATE.tasks[nid] = {id:nid, title:'Nuovo compito', points:1};
    saveState(STATE);
    openTaskEditor();
  });
}

function openSettings(){
  const modalRoot = document.getElementById('modal-root'); modalRoot.innerHTML='';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  sheet.innerHTML = `<div class="flex-between"><strong>Impostazioni</strong><button id="close">Chiudi</button></div>
    <label>Nome Maria</label><input id="name-maria" value="${STATE.players[0].name}" />
    <label>Nome Luca</label><input id="name-luca" value="${STATE.players[1].name}" />
    <label>Colore Maria (css var)</label><input id="color-maria" value="${getComputedStyle(document.documentElement).getPropertyValue('--maria')}" />
    <label>Colore Luca (css var)</label><input id="color-luca" value="${getComputedStyle(document.documentElement).getPropertyValue('--luca')}" />
    <div style="margin-top:10px"><button class="btn" id="save-set">Salva impostazioni</button></div>`;
  modal.appendChild(sheet); modalRoot.appendChild(modal);
  sheet.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
  sheet.querySelector('#save-set').addEventListener('click', ()=>{
    STATE.players[0].name = sheet.querySelector('#name-maria').value.trim() || 'Maria';
    STATE.players[1].name = sheet.querySelector('#name-luca').value.trim() || 'Luca';
    document.documentElement.style.setProperty('--maria', sheet.querySelector('#color-maria').value.trim() || '#2e8b57');
    document.documentElement.style.setProperty('--luca', sheet.querySelector('#color-luca').value.trim() || '#c62828');
    saveState(STATE);
    modalRoot.innerHTML=''; buildGrid();
  });
}

/* History view (same page) */
function showHistoryView(){
  document.getElementById('main-view').classList.add('hidden');
  document.getElementById('history-view').classList.remove('hidden');
  renderHistory();
}
function showCalendar(){
  document.getElementById('history-view').classList.add('hidden');
  document.getElementById('main-view').classList.remove('hidden');
}

/* render history list */
function renderHistory(){
  const y = STATE.settings.currentYear;
  const m = STATE.settings.currentMonth;
  const key = getMonthKey(y,m);
  const monthData = STATE.records[key] || {};
  const list = document.getElementById('history-list');
  list.innerHTML = '';
  const days = Object.keys(monthData).sort((a,b)=>b-a); // most recent first
  if(days.length===0){ list.innerHTML = '<div class="small">Nessuna voce per questo mese.</div>'; return; }
  days.forEach(d=>{
    const dayBox = document.createElement('div'); dayBox.className='history-day';
    const h = document.createElement('div'); h.style.fontWeight='700'; h.style.marginBottom='6px'; h.textContent = d + ' — ' + formatMonth(y,m).split(' ')[0];
    dayBox.appendChild(h);
    (monthData[d]||[]).slice().reverse().forEach(r=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='6px';
      const left = document.createElement('div'); left.textContent = (r.delta>0?'+':'')+r.delta + ' — ' + (r.note || (STATE.tasks[r.taskId] ? STATE.tasks[r.taskId].title : ''));
      const right = document.createElement('div');
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Modifica'; edit.addEventListener('click', ()=> openEditRecord(y,m,Number(d),r));
      right.appendChild(edit);
      row.appendChild(left); row.appendChild(right);
      dayBox.appendChild(row);
    });
    list.appendChild(dayBox);
  });
}

/* Summary */
function openSummary(){
  const y = STATE.settings.currentYear;
  const m = STATE.settings.currentMonth;
  const key = getMonthKey(y,m);
  const monthData = STATE.records[key] || {};
  let totals = {maria:0, luca:0};
  let obligatoryCount = {maria:0, luca:0};
  for(const day in monthData){
    monthData[day].forEach(r=>{
      totals[r.playerId] += r.delta;
      const isRecurring = STATE.recurring.some(rc => rc.taskId === r.taskId);
      if(isRecurring && r.delta>0) obligatoryCount[r.playerId]++;
    });
  }
  const winner = totals.maria >= totals.luca ? 'maria' : 'luca';
  const mostResponsible = obligatoryCount.maria >= obligatoryCount.luca ? 'maria' : 'luca';

  const modalRoot = document.getElementById('modal-root'); modalRoot.innerHTML='';
  const modal = document.createElement('div'); modal.className='modal';
  const sheet = document.createElement('div'); sheet.className='sheet';
  sheet.innerHTML = `<div class="flex-between"><strong>Riepilogo — ${formatMonth(y,m)}</strong><button id="close">Chiudi</button></div>
    <div style="margin-top:6px">
      <div><strong>${STATE.players[0].name}:</strong> ${totals.maria} punti</div>
      <div><strong>${STATE.players[1].name}:</strong> ${totals.luca} punti</div>
    </div>
    <div style="margin-top:8px">
      <div><span class="badge">Vincitore: ${STATE.players[winner==='maria'?0:1].name}</span></div>
      <div style="margin-top:6px"><span class="badge">Più responsabile: ${STATE.players[mostResponsible==='maria'?0:1].name}</span></div>
    </div>
    <div style="margin-top:8px">
      <strong>Premio suggerito:</strong> <div style="margin-top:6px">Il vincitore del mese è <em>libero dai piatti per una settimana</em> (da concordare).</div>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="close2">OK</button>
    </div>
  `;
  modal.appendChild(sheet); modalRoot.appendChild(modal);
  sheet.querySelector('#close').addEventListener('click', ()=> modalRoot.innerHTML='');
  sheet.querySelector('#close2').addEventListener('click', ()=> modalRoot.innerHTML='');
}

/* init */
function init(){
  if(Object.keys(STATE.tasks).length===0){
    PRESET_TASKS.forEach(t => STATE.tasks[t.id] = {...t});
    PRESET_OPS.forEach(t => STATE.tasks[t.id] = {...t});
    saveState(STATE);
  }
  buildGrid();
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js').catch(()=>{/*ok*/});
  }
}
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
init();
</script>
</body>
</html>
